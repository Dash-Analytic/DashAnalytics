{% extends "base.html" %} {% block title %}Geographical Insights -
DashAnalytics{% endblock %} {% block content %}
<div class="mb-6">
    <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
        <h2 class="text-xl font-bold text-gray-900 dark:text-gray-100 mb-4">
            Geographical Insights
        </h2>

        <div class="flex flex-wrap mb-6">
            <!-- Time Period Filter -->
            <div class="w-full md:w-1/4 mb-4 md:mb-0 md:mr-4">
                <label
                    for="period-select"
                    class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
                    >Time Period</label
                >
                <select
                    id="period-select"
                    class="bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md px-3 py-2 w-full"
                >
                    <option value="last-month">Last Month</option>
                    <option value="last-quarter">Last Quarter</option>
                    <option value="last-year" selected>Last Year</option>
                    <option value="all-time">All Time</option>
                </select>
            </div>

            <!-- Region Filter -->
            <div class="w-full md:w-1/4 mb-4 md:mb-0 md:mr-4">
                <label
                    for="region-select"
                    class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
                    >Region</label
                >
                <select
                    id="region-select"
                    class="bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md px-3 py-2 w-full"
                >
                    <option value="all" selected>All Regions</option>
                    <option value="north-america">North America</option>
                    <option value="europe">Europe</option>
                    <option value="asia">Asia</option>
                    <option value="south-america">South America</option>
                    <option value="africa">Africa</option>
                    <option value="oceania">Oceania</option>
                </select>
            </div>

            <!-- Apply Filters Button -->
            <div class="w-full md:w-auto self-end mb-4 md:mb-0">
                <button
                    id="apply-filters"
                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md transition"
                >
                    Apply Filters
                </button>
                <button
                    id="reset-filters"
                    class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md transition ml-2"
                >
                    Reset
                </button>
            </div>
        </div>
    </div>
</div>

<!-- World Map -->
<div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6 mb-6">
    <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4">
        Sales Distribution by City
    </h3>
    <div class="h-96 relative">
        <div id="world-map" class="w-full h-full"></div>
        <style>
            /* Fix for zoom controls alignment */
            .jvm-zoom-btn {
                position: absolute;
                left: auto !important;
                right: 10px !important;
                top: auto !important;
                bottom: 10px !important;
                width: 24px !important;
                height: 24px !important;
                display: flex !important;
                justify-content: center;
                align-items: center;
                font-size: 16px !important;
                border: 1px solid #ccc !important;
                color: #333 !important;
                background-color: white !important;
                border-radius: 4px !important;
            }
            .jvm-zoom-btn.jvm-zoomin {
                bottom: 40px !important;
            }
            .dark .jvm-zoom-btn {
                background-color: #374151 !important;
                color: #e5e7eb !important;
                border-color: #4b5563 !important;
            }
        </style>
    </div>
    <div class="mt-3 text-sm text-gray-600 dark:text-gray-400 flex flex-col">
        <div class="flex items-center mb-2">
            <span
                class="inline-block w-5 h-5 rounded-full bg-blue-500 mr-2 shadow-sm border-2 border-white dark:border-gray-800"
            ></span>
            <span class="font-medium">Top 5 cities by customer count</span>
            <span class="text-xs ml-2 italic">(always visible, labeled)</span>
        </div>
        <div class="flex items-center">
            <span
                class="inline-block w-3 h-3 rounded-full bg-orange-500 mr-2 opacity-70"
            ></span>
            <span>Other cities with data</span>
        </div>
    </div>
</div>

<!-- City Analysis Grid -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <!-- Top Cities by Customer Count -->
    <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4">
            Top Cities by Customer Count
        </h3>
        <div class="h-80">
            <canvas id="topCustomersChart"></canvas>
        </div>
    </div>

    <!-- Bottom Cities by Customer Count -->
    <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4">
            Bottom Cities by Customer Count
        </h3>
        <div class="h-80">
            <canvas id="bottomCustomersChart"></canvas>
        </div>
    </div>

    <!-- Top Cities by Profit -->
    <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4">
            Top Cities by Total Profit
        </h3>
        <div class="h-80">
            <canvas id="topProfitChart"></canvas>
        </div>
    </div>

    <!-- Cities by Highest Loss -->
    <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4">
            Cities by Highest Loss
        </h3>
        <div class="h-80">
            <canvas id="topLossChart"></canvas>
        </div>
    </div>
</div>

{% endblock %} {% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jsvectormap/1.5.3/js/jsvectormap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jsvectormap/1.5.3/maps/world.js"></script>

<script>
    // Chart objects
    let worldMap, countriesChart, citiesChart;
    let topCustomersChart, bottomCustomersChart, topProfitChart, topLossChart;

    document.addEventListener("DOMContentLoaded", function () {
        // Load initial data
        setTimeout(() => {
            fetchGeographicalData();
        }, 100);

        // Set up event listeners
        document
            .getElementById("apply-filters")
            .addEventListener("click", function () {
                showLoading();
                setTimeout(fetchGeographicalData, 100);
            });

        document
            .getElementById("reset-filters")
            .addEventListener("click", function () {
                document.getElementById("period-select").value = "last-year";
                document.getElementById("region-select").value = "all";
                showLoading();
                setTimeout(fetchGeographicalData, 100);
            });
    });

    function showLoading() {
        // Add loading overlay to charts
        const chartContainers = document.querySelectorAll(
            ".h-64, .h-80, .h-96"
        );
        chartContainers.forEach((container) => {
            if (!container.querySelector(".loading-overlay")) {
                const overlay = document.createElement("div");
                overlay.className =
                    "loading-overlay absolute inset-0 bg-white bg-opacity-75 dark:bg-gray-800 dark:bg-opacity-75 flex items-center justify-center";
                overlay.innerHTML = '<div class="spinner"></div>';
                container.style.position = "relative";
                container.appendChild(overlay);
            }
        });
    }

    function hideLoading() {
        // Remove loading overlays
        document.querySelectorAll(".loading-overlay").forEach((overlay) => {
            overlay.remove();
        });
    }

    function fetchGeographicalData() {
        showLoading();

        // Get filter values
        const periodValue = document.getElementById("period-select").value;
        const regionValue = document.getElementById("region-select").value;

        console.log(
            `Fetching geographical data - Period: ${periodValue}, Region: ${regionValue}`
        );

        // Construct API URL with query parameters
        const apiUrl = `/api/analytics/geographical/?period=${periodValue}&region=${regionValue}`;

        fetch(apiUrl)
            .then((response) => {
                console.log("API Response status:", response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .catch((error) => {
                console.error("Error parsing API response JSON:", error);
                throw new Error("Failed to parse API response as JSON");
            })
            .then((data) => {
                console.log("Received geographical data:", data);

                // Validate data structure before rendering
                if (!data) {
                    console.error("No data received from API");
                    throw new Error("No data received from API");
                }

                // Create empty structures for missing data components
                // This ensures that our rendering functions don't fail when data is missing
                if (!data.cityCustomers) {
                    console.warn(
                        "No city customer data received, creating empty structure"
                    );
                    data.cityCustomers = {
                        top: { labels: [], data: [] },
                        bottom: { labels: [], data: [] },
                    };
                }

                if (!data.cityProfit) {
                    console.warn(
                        "No city profit data received, creating empty structure"
                    );
                    data.cityProfit = {
                        profit: { labels: [], data: [] },
                        loss: { labels: [], data: [] },
                    };
                }

                if (!data.mapData) {
                    console.warn(
                        "No map data received, creating empty structure"
                    );
                    data.mapData = {};
                }

                // Render components with the validated data
                renderCityCustomersCharts(data.cityCustomers);
                renderCityProfitCharts(data.cityProfit);

                // Extract just the map data for the map rendering function
                const mapData = {
                    cityCustomers: data.cityCustomers,
                    cityProfit: data.cityProfit,
                    mapData: data.mapData,
                };
                console.log("Calling renderWorldMap with map data:", mapData);
                renderWorldMap(mapData);

                hideLoading();
            })
            .catch((error) => {
                console.error("Error loading geographical data:", error);
                hideLoading();

                // Show detailed error message on the page instead of a generic one
                const chartContainers = document.querySelectorAll(
                    ".h-64, .h-80, .h-96"
                );
                chartContainers.forEach((container) => {
                    container.innerHTML = `
                        <div class="flex items-center justify-center h-full">
                            <div class="text-center">
                                <p class="text-red-500 dark:text-red-400 mb-2">
                                    Failed to load geographical data
                                </p>
                                <p class="text-gray-500 dark:text-gray-400 text-sm">
                                    ${
                                        error.message ||
                                        "Please try again or contact support if the problem persists"
                                    }
                                </p>
                            </div>
                        </div>
                    `;
                });
            });
    }

    function renderCityCustomersCharts(data) {
        // Validate input data
        if (!data || !data.top || !data.bottom) {
            console.error(
                "Invalid data structure for city customer charts:",
                data
            );
            return;
        }

        console.log("Rendering city customers charts with data:", data);
        const chartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: "Number of Customers",
                    },
                },
            },
        };

        // Top Cities Chart
        const topCtx = document
            .getElementById("topCustomersChart")
            .getContext("2d");
        if (topCustomersChart) topCustomersChart.destroy();
        topCustomersChart = new Chart(topCtx, {
            type: "bar",
            data: {
                labels: data.top.labels,
                datasets: [
                    {
                        label: "Top Cities by Customer Count",
                        data: data.top.data,
                        backgroundColor: "rgba(59, 130, 246, 0.6)",
                        borderColor: "#3b82f6",
                        borderWidth: 1,
                    },
                ],
            },
            options: chartOptions,
        });

        // Bottom Cities Chart
        const bottomCtx = document
            .getElementById("bottomCustomersChart")
            .getContext("2d");
        if (bottomCustomersChart) bottomCustomersChart.destroy();
        bottomCustomersChart = new Chart(bottomCtx, {
            type: "bar",
            data: {
                labels: data.bottom.labels,
                datasets: [
                    {
                        label: "Bottom Cities by Customer Count",
                        data: data.bottom.data,
                        backgroundColor: "rgba(239, 68, 68, 0.6)",
                        borderColor: "#ef4444",
                        borderWidth: 1,
                    },
                ],
            },
            options: chartOptions,
        });
    }

    function renderCityProfitCharts(data) {
        // Log data to check what we're receiving
        console.log("Profit/Loss data:", data);

        const chartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: "Amount ($)",
                    },
                    ticks: {
                        callback: function (value) {
                            return "$" + Math.abs(value).toLocaleString();
                        },
                    },
                },
                x: {
                    ticks: {
                        autoSkip: false,
                        maxRotation: 45,
                        minRotation: 45,
                    },
                },
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function (context) {
                            return (
                                "$" +
                                Math.abs(context.parsed.y).toLocaleString()
                            );
                        },
                    },
                },
            },
        };

        try {
            // Validate we have a proper data structure
            if (!data || typeof data !== "object") {
                throw new Error(
                    "Invalid data structure for profit/loss charts"
                );
            }

            // Handle profit chart
            const profitContainer = document.getElementById("topProfitChart");
            if (profitContainer) {
                const profitCtx = profitContainer.getContext("2d");

                // Make sure we have valid data before rendering
                if (
                    data.profit &&
                    Array.isArray(data.profit.labels) &&
                    Array.isArray(data.profit.data) &&
                    data.profit.labels.length > 0 &&
                    data.profit.data.length > 0
                ) {
                    // Check for any null or undefined values in data
                    const validProfitData = data.profit.data.map((val) => {
                        if (
                            val === null ||
                            val === undefined ||
                            isNaN(parseFloat(val))
                        ) {
                            return 0;
                        }
                        return Math.abs(parseFloat(val));
                    });

                    // Destroy existing chart if it exists
                    if (topProfitChart) topProfitChart.destroy();

                    // Create new chart
                    topProfitChart = new Chart(profitCtx, {
                        type: "bar",
                        data: {
                            labels: data.profit.labels,
                            datasets: [
                                {
                                    label: "Total Profit",
                                    data: validProfitData,
                                    backgroundColor: "rgba(16, 185, 129, 0.6)",
                                    borderColor: "#10b981",
                                    borderWidth: 1,
                                },
                            ],
                        },
                        options: chartOptions,
                    });
                } else {
                    console.warn("No profit data available for chart");
                    profitContainer.parentNode.innerHTML =
                        '<div class="flex items-center justify-center h-full text-gray-500">No profit data available</div>';
                }
            }

            // Handle loss chart
            const lossContainer = document.getElementById("topLossChart");
            if (lossContainer) {
                const lossCtx = lossContainer.getContext("2d");

                // Make sure we have valid data before rendering
                if (
                    data.loss &&
                    Array.isArray(data.loss.labels) &&
                    Array.isArray(data.loss.data) &&
                    data.loss.labels.length > 0 &&
                    data.loss.data.length > 0
                ) {
                    // Check for any null or undefined values in data
                    const validLossData = data.loss.data.map((val) => {
                        if (
                            val === null ||
                            val === undefined ||
                            isNaN(parseFloat(val))
                        ) {
                            return 0;
                        }
                        return Math.abs(parseFloat(val));
                    });

                    // Destroy existing chart if it exists
                    if (topLossChart) topLossChart.destroy();

                    // Create new chart
                    topLossChart = new Chart(lossCtx, {
                        type: "bar",
                        data: {
                            labels: data.loss.labels,
                            datasets: [
                                {
                                    label: "Total Loss",
                                    data: validLossData,
                                    backgroundColor: "rgba(239, 68, 68, 0.6)",
                                    borderColor: "#ef4444",
                                    borderWidth: 1,
                                },
                            ],
                        },
                        options: chartOptions,
                    });
                } else {
                    console.warn("No loss data available for chart");
                    lossContainer.parentNode.innerHTML =
                        '<div class="flex items-center justify-center h-full text-gray-500">No loss data available</div>';
                }
            }
        } catch (error) {
            console.error("Error rendering profit/loss charts:", error);

            // Provide fallback displays for both charts on error
            const charts = ["topProfitChart", "topLossChart"];
            charts.forEach((chartId) => {
                const container = document.getElementById(chartId);
                if (container) {
                    container.parentNode.innerHTML =
                        '<div class="flex items-center justify-center h-full text-red-500">Error loading chart data</div>';
                }
            });
        }
    }

    // Map coordinates for cities in our database
    const cityCoordinates = {
        // North America
        "New York": [40.7128, -74.006],
        "Los Angeles": [34.0522, -118.2437],
        Chicago: [41.8781, -87.6298],
        Houston: [29.7604, -95.3698],
        Phoenix: [33.4484, -112.074],
        Philadelphia: [39.9526, -75.1652],
        "San Antonio": [29.4241, -98.4936],
        "San Diego": [32.7157, -117.1611],
        Dallas: [32.7767, -96.797],
        "San Jose": [37.3382, -121.8863],
        Toronto: [43.6511, -79.347],
        Montreal: [45.5017, -73.5673],
        Vancouver: [49.2827, -123.1207],
        Calgary: [51.0447, -114.0719],
        Edmonton: [53.5461, -113.4938],
        "Mexico City": [19.4326, -99.1332],
        Guadalajara: [20.6597, -103.3496],
        Monterrey: [25.6866, -100.3161],
        Puebla: [19.0413, -98.2062],
        Tijuana: [32.5149, -117.0382],

        // Europe
        London: [51.5074, -0.1278],
        Birmingham: [52.4862, -1.8904],
        Manchester: [53.4808, -2.2426],
        Liverpool: [53.4084, -2.9916],
        Glasgow: [55.8642, -4.2518],
        Paris: [48.8566, 2.3522],
        Marseille: [43.2965, 5.3698],
        Lyon: [45.764, 4.8357],
        Toulouse: [43.6047, 1.4442],
        Nice: [43.7102, 7.262],
        Berlin: [52.52, 13.405],
        Hamburg: [53.5511, 9.9937],
        Munich: [48.1351, 11.582],
        Cologne: [50.9375, 6.9603],
        Frankfurt: [50.1109, 8.6821],
        Amsterdam: [52.3676, 4.9041],
        Rotterdam: [51.9244, 4.4777],
        "The Hague": [52.0705, 4.3007],
        Utrecht: [52.0907, 5.1214],
        Eindhoven: [51.4416, 5.4697],

        // Asia
        Tokyo: [35.6762, 139.6503],
        Osaka: [34.6937, 135.5023],
        Yokohama: [35.4437, 139.638],
        Nagoya: [35.1815, 136.9066],
        Sapporo: [43.0618, 141.3545],
        Beijing: [39.9042, 116.4074],
        Shanghai: [31.2304, 121.4737],
        Guangzhou: [23.1291, 113.2644],
        Shenzhen: [22.5431, 114.0579],
        Chongqing: [29.4316, 106.9123],
        Mumbai: [19.076, 72.8777],
        Delhi: [28.7041, 77.1025],
        Bangalore: [12.9716, 77.5946],
        Hyderabad: [17.385, 78.4867],
        Chennai: [13.0827, 80.2707],

        // Australia/Oceania
        Sydney: [-33.8688, 151.2093],
        Melbourne: [-37.8136, 144.9631],
        Brisbane: [-27.4705, 153.026],
        Perth: [-31.9505, 115.8605],
        Adelaide: [-34.9285, 138.6007],

        // South America
        "São Paulo": [-23.5505, -46.6333],
        "Rio de Janeiro": [-22.9068, -43.1729],
        Brasília: [-15.7801, -47.9292],
        Salvador: [-12.9714, -38.5014],
        Fortaleza: [-3.7319, -38.5267],

        // Africa
        Cairo: [30.0444, 31.2357],
        Lagos: [6.5244, 3.3792],
        Nairobi: [-1.2921, 36.8219],
        "Cape Town": [-33.9249, 18.4241],
        Johannesburg: [-26.2041, 28.0473],
    };

    // Rendering functions
    function renderWorldMap(data) {
        if (!data) {
            console.error("renderWorldMap called with null or undefined data");
            return;
        }

        // Clear previous map if it exists
        const mapContainer = document.getElementById("world-map");
        if (!mapContainer) {
            console.error("World map container not found in the DOM");
            return;
        }
        mapContainer.innerHTML = "";

        // Enable detailed debugging
        console.group("Map Rendering Debug");
        console.log("Full data for map:", data);

        const isDarkMode = document.documentElement.classList.contains("dark");
        const backgroundColor = isDarkMode ? "#1f2937" : "#ffffff";
        const regionColor = isDarkMode ? "#374151" : "#e5e7eb";
        const selectedRegionColor = "#3b82f6";
        const textColor = isDarkMode ? "#e5e7eb" : "#374151";

        console.log("Map container:", mapContainer);
        console.log("Dark mode:", isDarkMode);

        // Extract the mapData specifically for country coloring
        const mapData = data.mapData || {};

        console.log("Map data:", mapData);
        console.log("City customers data:", data.cityCustomers);

        // Check if there's any data at all - we can still display markers even if mapData is empty
        const hasData =
            data.cityCustomers &&
            ((data.cityCustomers.top &&
                data.cityCustomers.top.labels &&
                data.cityCustomers.top.labels.length) ||
                (data.cityCustomers.bottom &&
                    data.cityCustomers.bottom.labels &&
                    data.cityCustomers.bottom.labels.length));

        if (!hasData && (!mapData || Object.keys(mapData).length === 0)) {
            console.log("No geographical data available to display");
            const errorMessage = document.createElement("div");
            errorMessage.className = "flex items-center justify-center h-full";
            errorMessage.innerHTML =
                '<p class="text-gray-500 dark:text-gray-400">No geographical data available to display</p>';
            mapContainer.appendChild(errorMessage);
            console.groupEnd();
            return;
        }

        // Calculate max value for consistent scaling with safeguards
        const mapDataValues = Object.values(mapData);
        console.log("Map data values:", mapDataValues);

        const maxValue =
            mapDataValues.length > 0 ? Math.max(1, ...mapDataValues) : 1; // Ensure we don't divide by zero
        console.log("Calculated max value for scaling:", maxValue);

        // Transform data for jsvectormap with error handling
        const mapValues = {};
        try {
            Object.keys(mapData).forEach((country) => {
                // Ensure the value is scaled properly between 0-100
                const scaledValue = (mapData[country] / maxValue) * 100;
                mapValues[country] = isFinite(scaledValue) ? scaledValue : 0;
            });
            console.log(
                "Map values prepared:",
                Object.keys(mapValues).length,
                "countries"
            );
        } catch (e) {
            console.error("Error preparing map values:", e);
            // Provide fallback data if needed
        }

        // Add markers only for cities in our actual data
        const markers = [];

        // First identify top cities by customer count - these will get distinctive styling
        const topCitiesByCustomers = new Set();

        // Always add at least one default top city to ensure we have a marker
        if (cityCoordinates["New York"]) {
            topCitiesByCustomers.add("New York");
        }

        // Extract top 5 cities by customer count for distinctive markers (top priority)
        if (
            data.cityCustomers &&
            data.cityCustomers.top &&
            Array.isArray(data.cityCustomers.top.labels)
        ) {
            // Get the cities with the highest customer counts (top 5)
            const topCities = data.cityCustomers.top.labels.slice(0, 5);
            topCities.forEach((city) => topCitiesByCustomers.add(city));
            console.log(
                "Top cities by customers:",
                Array.from(topCitiesByCustomers)
            );
        } else {
            // If no city data, add some default top cities
            ["London", "Tokyo", "Sydney", "Paris", "Berlin"].forEach((city) => {
                if (cityCoordinates[city]) {
                    topCitiesByCustomers.add(city);
                }
            });
        }

        // Add all cities that appear in our data
        const citiesInData = new Set();

        // Add cities from profit data
        if (
            data.cityProfit &&
            data.cityProfit.profit &&
            Array.isArray(data.cityProfit.profit.labels)
        ) {
            data.cityProfit.profit.labels.forEach((city) =>
                citiesInData.add(city)
            );
        }

        // Add cities from loss data
        if (
            data.cityProfit &&
            data.cityProfit.loss &&
            Array.isArray(data.cityProfit.loss.labels)
        ) {
            data.cityProfit.loss.labels.forEach((city) =>
                citiesInData.add(city)
            );
        }

        // Add cities from customer data (both top and bottom)
        if (
            data.cityCustomers &&
            data.cityCustomers.top &&
            Array.isArray(data.cityCustomers.top.labels)
        ) {
            data.cityCustomers.top.labels.forEach((city) =>
                citiesInData.add(city)
            );
        }

        if (
            data.cityCustomers &&
            data.cityCustomers.bottom &&
            Array.isArray(data.cityCustomers.bottom.labels)
        ) {
            data.cityCustomers.bottom.labels.forEach((city) =>
                citiesInData.add(city)
            );
        }

        // First add all top cities to ensure they're always visible
        if (topCitiesByCustomers.size > 0) {
            Array.from(topCitiesByCustomers).forEach((city) => {
                if (cityCoordinates[city]) {
                    markers.push({
                        name: city,
                        coords: cityCoordinates[city],
                        style: {
                            fill: "#3b82f6", // Blue color for top cities
                            r: 10, // Larger radius for more prominence
                            stroke: "#fff",
                            "stroke-width": 3, // Thicker border
                            "stroke-opacity": 0.8,
                            "fill-opacity": 1, // Full opacity for top cities
                        },
                    });
                    // Add to citiesInData so we don't duplicate
                    citiesInData.add(city);
                }
            });
        }

        // Convert to array and add markers for all other cities that have coordinates
        Array.from(citiesInData).forEach((city) => {
            // Skip top cities as they've already been added
            if (!topCitiesByCustomers.has(city) && cityCoordinates[city]) {
                markers.push({
                    name: city,
                    coords: cityCoordinates[city],
                    style: {
                        fill: "#ff9e00", // Orange for regular cities
                        r: 5, // Default radius
                        "fill-opacity": 0.7, // Slightly transparent for regular cities
                    },
                });
            }
        });

        // Verify markers before creating the map
        console.log("Markers before map creation:", markers);
        if (markers.length === 0) {
            console.warn(
                "No markers available for the map. Adding a default marker for testing."
            );
            // Add a default marker for New York as a fallback
            if (cityCoordinates["New York"]) {
                markers.push({
                    name: "New York (Default)",
                    coords: cityCoordinates["New York"],
                    style: {
                        fill: "#ff0000",
                        r: 8,
                        stroke: "#fff",
                        "stroke-width": 2,
                    },
                });
            }
        }

        // Create new map
        try {
            console.log("Creating map with markers:", markers.length);
            // Configure focus settings if we have top cities
            const mapOptions = {
                selector: "#world-map",
                map: "world",
                backgroundColor: backgroundColor,
                regionStyle: {
                    initial: {
                        fill: regionColor,
                        stroke: isDarkMode ? "#4b5563" : "#d1d5db",
                        "stroke-width": 0.5,
                    },
                    hover: {
                        fill: "#60a5fa",
                    },
                    selected: {
                        fill: selectedRegionColor,
                    },
                },
                markers: markers,
                markerStyle: {
                    initial: {
                        r: 5,
                        fill: "#ff9e00", // Default color for regular cities
                        stroke: "#fff",
                        "stroke-width": 2,
                        "stroke-opacity": 0.6,
                    },
                    hover: {
                        r: 12, // Larger hover state for better visibility
                        stroke: "#fff",
                        "stroke-width": 3,
                        "stroke-opacity": 1,
                    },
                    // Setting to false so individual marker styles will take precedence
                    inherit: false,
                },
                labels: {
                    markers: {
                        render: (marker) => {
                            // Only show labels for top cities
                            return topCitiesByCustomers.has(marker.name)
                                ? marker.name
                                : null;
                        },
                        offsets: (index) => [0, 0],
                    },
                },
                series: {
                    regions: [
                        {
                            values: mapValues,
                            scale: ["#c6e0ff", "#0059ff"],
                            normalizeFunction: "linear",
                        },
                    ],
                },
                onRegionTipShow: function (event, tooltip, code) {
                    if (data[code]) {
                        tooltip.innerHTML = `${tooltip.innerHTML}: $${data[
                            code
                        ].toLocaleString()}`;
                    } else {
                        tooltip.innerHTML = `${tooltip.innerHTML}: No data available`;
                    }
                },
                onMarkerTipShow: function (event, tooltip, code) {
                    try {
                        const marker = markers[code];
                        if (marker && marker.name) {
                            const city = marker.name;
                            if (topCitiesByCustomers.has(city)) {
                                tooltip.innerHTML = `<strong>${city}</strong> (Top city)`;
                            } else {
                                tooltip.innerHTML = city;
                            }
                        } else {
                            console.warn(
                                "Missing marker or marker name for tooltip",
                                code
                            );
                            tooltip.innerHTML = "City data unavailable";
                        }
                    } catch (e) {
                        console.error("Error in marker tooltip:", e);
                        tooltip.innerHTML = "Error displaying city data";
                    }
                },
            };

            // Initialize the map
            worldMap = new jsVectorMap(mapOptions);

            // Add animation specifically highlighting top cities after the map is loaded
            setTimeout(() => {
                if (topCitiesByCustomers.size > 0 && markers.length > 0) {
                    // Find the indices of top cities in the markers array
                    const topCityIndices = markers
                        .map((marker, index) =>
                            topCitiesByCustomers.has(marker.name) ? index : -1
                        )
                        .filter((index) => index !== -1);

                    // Flash top city markers with animation
                    if (topCityIndices.length > 0) {
                        // Highlight these markets momentarily
                        worldMap.setSelectedMarkers(topCityIndices);

                        // After a short delay, reset the selection
                        setTimeout(() => {
                            worldMap.clearSelectedMarkers();
                        }, 1500);
                    }
                }
            }, 500);
        } catch (error) {
            console.error("Error rendering world map:", error);
            console.trace("Stack trace for error:");

            const errorMessage = document.createElement("div");
            errorMessage.className = "flex items-center justify-center h-full";
            errorMessage.innerHTML =
                '<p class="text-red-500">Error loading map. Please try again.</p>';
            mapContainer.appendChild(errorMessage);
        }

        console.log("Map markers count:", markers.length);
        console.log("Top cities count:", topCitiesByCustomers.size);
        console.groupEnd();
    }

    function renderCountriesChart(data) {
        const ctx = document.getElementById("countriesChart").getContext("2d");

        if (countriesChart) {
            countriesChart.destroy();
        }

        const isDarkMode = document.documentElement.classList.contains("dark");
        const gridColor = isDarkMode
            ? "rgba(255, 255, 255, 0.1)"
            : "rgba(0, 0, 0, 0.1)";
        const textColor = isDarkMode ? "#e5e7eb" : "#374151";

        requestAnimationFrame(() => {
            countriesChart = new Chart(ctx, {
                type: "bar",
                data: {
                    labels: data.labels,
                    datasets: [
                        {
                            label: "Sales (in thousands $)",
                            data: data.data,
                            backgroundColor: "rgba(59, 130, 246, 0.6)",
                            borderColor: "#3b82f6",
                            borderWidth: 1,
                        },
                    ],
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: "y",
                    animation: {
                        duration: 300,
                    },
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: textColor,
                            },
                        },
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid: {
                                color: gridColor,
                            },
                            ticks: {
                                color: textColor,
                                callback: function (value) {
                                    return "$" + value.toLocaleString();
                                },
                            },
                        },
                        y: {
                            grid: {
                                color: gridColor,
                            },
                            ticks: {
                                color: textColor,
                            },
                        },
                    },
                },
            });
        });
    }

    function renderCitiesChart(data) {
        const ctx = document.getElementById("citiesChart").getContext("2d");

        if (citiesChart) {
            citiesChart.destroy();
        }

        const isDarkMode = document.documentElement.classList.contains("dark");
        const gridColor = isDarkMode
            ? "rgba(255, 255, 255, 0.1)"
            : "rgba(0, 0, 0, 0.1)";
        const textColor = isDarkMode ? "#e5e7eb" : "#374151";

        requestAnimationFrame(() => {
            citiesChart = new Chart(ctx, {
                type: "bar",
                data: {
                    labels: data.labels,
                    datasets: [
                        {
                            label: "Sales (in thousands $)",
                            data: data.data,
                            backgroundColor: "rgba(16, 185, 129, 0.6)",
                            borderColor: "#10b981",
                            borderWidth: 1,
                        },
                    ],
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: "y",
                    animation: {
                        duration: 300,
                    },
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: textColor,
                            },
                        },
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid: {
                                color: gridColor,
                            },
                            ticks: {
                                color: textColor,
                                callback: function (value) {
                                    return "$" + value.toLocaleString();
                                },
                            },
                        },
                        y: {
                            grid: {
                                color: gridColor,
                            },
                            ticks: {
                                color: textColor,
                            },
                        },
                    },
                },
            });
        });
    }

    // The renderRegionsTable function was removed as the Sales Growth by Region section is no longer needed

    // Update charts when theme changes
    document.addEventListener("theme-changed", function () {
        if (countriesChart) {
            showLoading();
            setTimeout(fetchGeographicalData, 100);
        }
    });
</script>

<style>
    /* Custom styles for jsvectormap */
    .jvm-tooltip {
        background-color: #1f2937;
        color: #f3f4f6;
        border: none;
        border-radius: 0.25rem;
        padding: 0.5rem;
        font-size: 0.75rem;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
            0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    /* Spinner animation */
    .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid rgba(100, 116, 139, 0.2);
        border-top-color: #3b82f6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }
</style>
{% endblock %}
